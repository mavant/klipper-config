# This file contains common pin mappings for MKS Robin Nano V3
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "USB for communication".

# The "make flash" command does not work on the MKS Robin. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "Robin_nano_v3.bin" on an SD card and then restart the
# MKS Robin with that SD card.

# See docs/Config_Reference.md for a description of parameters.

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_1F0029000250474835363820-if00

[printer]
kinematics: delta
max_velocity: 7000
max_accel: 7000
max_z_velocity: 2000
# minimum_z_position should only be below zero when calibrating
#minimum_z_position: -5
square_corner_velocity: 31.0
print_radius: 132.5

[firmware_retraction]
retract_length: 6.5
retract_speed: 40
unretract_extra_length: 0
unretract_speed: 40

[idle_timeout]
timeout: 300

[gcode_arcs]
resolution: 0.75

########################################
# A (X-Stepper) Configuration
########################################
[stepper_a] # X
step_pin: PE3
dir_pin: PE2
enable_pin: !PE4
microsteps: 128
step_pulse_duration: 0.000000100
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PA15 #X_MAX
homing_speed: 90
homing_retract_dist: 3.0
homing_retract_speed: 10
second_homing_speed: 3.0

[tmc2209 stepper_a]
uart_pin: PD5
interpolate: false
run_current: 1.138
sense_resistor: 0.110

########################################
# B (Y-Stepper)  Configuration
########################################
[stepper_b] # Y
step_pin: PE0
dir_pin: PB9
enable_pin: !PE1
microsteps: 128
step_pulse_duration: 0.000000100
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PD2 #Y_MAX
homing_speed: 90
homing_retract_dist: 3.0
homing_retract_speed: 10
second_homing_speed: 3.0

[tmc2209 stepper_b]
uart_pin: PD7
interpolate: false
run_current: 1.138
sense_resistor: 0.110

########################################
# C (Z-Stepper)  Configuration
########################################
[stepper_c] # Z
step_pin: PB5
dir_pin: PB4
enable_pin: !PB8
microsteps: 128
step_pulse_duration: 0.000000100
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PC4 #Z_MAX
homing_speed: 90
homing_retract_dist: 3.0
homing_retract_speed: 10
second_homing_speed: 3.0

[tmc2209 stepper_c]
uart_pin: PD4
interpolate: false
run_current: 1.138
sense_resistor: 0.110

########################################
# Extruder Configuration
########################################
[extruder]
step_pin: PD6
dir_pin: !PD3
enable_pin: !PB3
microsteps: 32
gear_ratio: 50:17
rotation_distance: 25
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PE5
sensor_type: Generic 3950
sensor_pin: PC1
min_temp: 0
max_temp: 300
# Pressure_advance disabled by default.
# Commentary from danorder:
#  #set this from the slicer / fluidd / Mainsail. or start gcode its easier to do this in slicers with material specic gcode functions. 0.1-1.5 layer hight isn't usally benificial.

# max_extrude_only distance also from danorder.
# # 3:1 = /3 = 2800 (stock xyz acc) The rough gear ratio of bondtech.
max_extrude_only_distance: 8300

# instantaneous_corner_velocity changed from 2.5 to 15.
# comment from danorder:
# # The equivalent of extruder jerk. this does not speed up pressue advance like linear adance in marlin. higher values may improve bowden retract. eg 15 left slow as a safe default.
# where "left slow" meant "2.5" upstream.
instantaneous_corner_velocity: 15

[verify_heater extruder]
max_error: 150
check_gain_time: 30
hysteresis: 5
heating_gain: 2

[tmc2209 extruder]
uart_pin: PD9
interpolate: false
run_current: 1.1
sense_resistor: 0.110

########################################
# Bed Configuration
########################################

[heater_bed]
heater_pin: PA0
sensor_type: Generic 3950
sensor_pin: PC0
min_temp: 0
max_temp: 100

[verify_heater heater_bed]
check_gain_time: 120
hysteresis: 2.5

########################################
# Fan/Other Configuration
########################################

[fan]       # Part Cooling
pin: PC14

[heater_fan heatsink_fan] # Heatsink
pin: PB0 #PB1
max_power: 1.0
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

[delta_calibrate]
radius: 132.5
# Speed refers to non-probing moves.
# Assuming we have enough vertical space (horizontal_move_z)
# to avoid anything stuck to the plate, it can be quite fast.
speed: 150
# horizontal_move_z must be no less than the probe's z offset,
# or klipper will complain.
horizontal_move_z: 20

[bed_mesh]
speed: 120
horizontal_move_z: 20
# Mesh radius is currently set lower than the actual delta radius
# because it can sometimes hit the edge of the spring plate and get weird results.
# THat should eventually be fixed by having a spring plate the correct size.
mesh_radius: 130
mesh_origin: 0,0
round_probe_count: 21
algorithm: bicubic
fade_end: 10

[probe]
pin: ^!PC8 #Z_MIN
x_offset: 0
y_offset: 0
#z_offset = 18.000
speed: 5
lift_speed: 150
samples: 3
samples_result: average
sample_retract_dist: 3
samples_tolerance: 0.02
samples_tolerance_retries: 2
activate_gcode: PROBE_ACTIVATE_HOOK
deactivate_gcode: PROBE_DEACTIVATE_HOOK

[endstop_phase]

########################################
# Filament Runout
########################################

[filament_switch_sensor filament_runout_sensor]
switch_pin: PA4
pause_on_runout: true
runout_gcode:
    M600 ; pause macro

#insert_gcode:
#   A list of G-Code commands to execute after a filament insert is
#   detected. See docs/Command_Templates.md for G-Code format. The
#   default is not to run any G-Code commands, which disables insert
#   detection.
#event_delay: 3.0
#   The minimum amount of time in seconds to delay between events.
#   Events triggered during this time period will be silently
#   ignored. The default is 3 seconds.
#pause_delay: 0.5
#   The amount of time to delay, in seconds, between the pause command
#   dispatch and execution of the runout_gcode. It may be useful to
#   increase this delay if OctoPrint exhibits strange pause behavior.
#   Default is 0.5 seconds.


########################################
# Raspberry / Fluidd Configuration
########################################
[temperature_sensor rpi_temperature]
sensor_type: temperature_host

[temperature_sensor mcu_temperature]
sensor_type: temperature_mcu

[include fluidd.cfg]

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC5,  EXP1_3=PD13, EXP1_5=PE14, EXP1_7=PD11, EXP1_9=<GND>,
    EXP1_2=PE13, EXP1_4=PC6,  EXP1_6=PE15, EXP1_8=PD10, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE8, EXP2_5=PE11, EXP2_7=PE12,  EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PE10, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<3.3v>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp1"

# See the sample-lcd.cfg file for definitions of common LCD displays.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [printer]
#*# delta_radius = 150.309165
#*#
#*# [stepper_a]
#*# angle = 209.870653
#*# arm_length = 311.097052
#*# position_endstop = 338.510865
#*#
#*# [stepper_b]
#*# angle = 329.502184
#*# arm_length = 312.407140
#*# position_endstop = 337.728298
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 311.756449
#*# position_endstop = 338.258482
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 67.846
#*# pid_ki = 1.409
#*# pid_kd = 816.697
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.292
#*# pid_ki = 0.985
#*# pid_kd = 75.871
#*#
#*# [probe]
#*# z_offset = 17.459
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 458/512
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 354/512
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 223/512
#*#
#*# [bed_mesh PEI-spring-steel-60C]
#*# version = 1
#*# points =
#*# 	0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670, 0.021670
#*# 	0.027306, 0.027306, 0.027306, 0.027306, 0.027306, 0.027306, 0.027306, 0.032217, 0.042545, 0.022629, 0.008024, 0.009735, 0.024373, 0.029758, 0.048017, 0.048017, 0.048017, 0.048017, 0.048017, 0.048017, 0.048017
#*# 	0.029774, 0.029774, 0.029774, 0.029774, 0.029774, 0.030745, 0.028601, 0.017590, 0.026663, 0.016619, 0.015126, 0.000580, 0.009813, 0.016701, 0.038404, 0.054316, 0.055952, 0.055952, 0.055952, 0.055952, 0.055952
#*# 	0.008889, 0.008889, 0.008889, 0.008889, 0.029366, 0.036069, 0.032004, 0.019638, 0.024037, 0.028026, 0.021792, 0.005794, -0.003851, 0.001516, 0.011772, 0.029867, 0.040414, 0.057282, 0.057282, 0.057282, 0.057282
#*# 	-0.021997, -0.021997, -0.021997, -0.011369, 0.003603, 0.023183, 0.027041, 0.013488, 0.017635, 0.026519, 0.024834, 0.016733, -0.005151, -0.009569, -0.010029, 0.006573, 0.009620, 0.020074, 0.027476, 0.027476, 0.027476
#*# 	-0.037512, -0.037512, -0.037512, -0.030418, -0.004736, 0.022992, 0.025357, 0.019763, 0.009986, 0.008034, 0.013904, 0.014271, -0.001890, -0.025109, -0.036585, -0.029848, -0.023292, -0.032897, -0.031170, -0.031170, -0.031170
#*# 	-0.033064, -0.033064, -0.045167, -0.033854, -0.024131, 0.000729, 0.021300, 0.014003, -0.000674, -0.008692, -0.007666, -0.010229, -0.016744, -0.039054, -0.047789, -0.048564, -0.044718, -0.034915, -0.030189, -0.008516, -0.008516
#*# 	-0.005664, -0.005664, -0.009761, -0.008116, -0.001959, 0.001904, 0.023112, 0.018994, 0.011217, -0.011726, -0.030280, -0.028204, -0.030530, -0.037051, -0.049586, -0.061032, -0.054710, -0.042538, -0.032684, -0.009621, -0.009621
#*# 	0.018681, 0.018681, 0.013811, 0.000705, -0.002211, -0.004092, 0.001758, 0.009756, 0.004516, -0.011119, -0.033462, -0.041518, -0.045676, -0.042293, -0.052467, -0.054092, -0.052475, -0.040378, -0.015710, 0.006450, 0.006450
#*# 	0.039059, 0.039059, 0.044948, 0.042221, 0.028943, 0.012480, 0.006326, 0.026134, 0.009990, -0.005947, -0.028748, -0.039478, -0.047774, -0.047445, -0.047672, -0.051525, -0.057010, -0.045294, -0.017352, 0.018793, 0.018793
#*# 	0.072360, 0.057786, 0.060949, 0.053177, 0.037780, 0.017964, 0.005558, 0.002456, 0.002976, -0.003666, -0.023364, -0.043095, -0.053925, -0.048932, -0.051151, -0.049112, -0.045548, -0.031479, -0.013028, 0.029629, 0.068467
#*# 	0.086804, 0.086804, 0.071481, 0.061009, 0.054984, 0.034719, 0.011354, 0.002362, -0.003680, -0.011568, -0.024769, -0.039571, -0.054628, -0.055313, -0.042879, -0.040825, -0.031182, -0.027722, -0.014334, 0.043104, 0.043104
#*# 	0.093092, 0.093092, 0.067511, 0.053113, 0.051115, 0.042429, 0.020795, -0.003281, -0.018860, -0.025221, -0.019824, -0.031300, -0.049829, -0.056715, -0.036076, -0.020764, -0.020958, -0.015093, 0.014154, 0.066911, 0.066911
#*# 	0.104612, 0.104612, 0.071032, 0.048582, 0.048115, 0.051117, 0.035680, 0.009257, -0.013502, -0.023347, -0.029356, -0.026296, -0.030700, -0.041203, -0.033667, -0.019498, -0.003365, 0.003404, 0.029179, 0.077640, 0.077640
#*# 	0.091766, 0.091766, 0.047924, 0.031093, 0.028794, 0.029102, 0.026522, 0.014606, -0.002443, -0.019889, -0.013057, -0.009433, -0.017662, -0.018205, -0.021355, -0.004354, 0.016466, 0.031620, 0.053540, 0.102227, 0.102227
#*# 	0.024755, 0.024755, 0.024755, 0.022925, 0.023079, 0.021130, 0.030053, 0.019076, -0.000668, -0.009727, -0.007388, 0.005448, 0.013271, 0.013996, 0.014755, 0.026263, 0.052099, 0.068166, 0.092535, 0.092535, 0.092535
#*# 	0.014288, 0.014288, 0.014288, 0.016040, 0.023183, 0.017244, 0.018222, 0.029475, 0.013853, 0.004373, -0.001184, 0.016348, 0.039726, 0.039332, 0.050072, 0.062941, 0.092782, 0.129660, 0.161234, 0.161234, 0.161234
#*# 	0.012378, 0.012378, 0.012378, 0.012378, 0.016386, 0.013610, 0.017670, 0.028229, 0.021737, 0.008518, 0.000219, 0.012080, 0.046339, 0.077120, 0.094786, 0.109310, 0.136141, 0.206280, 0.206280, 0.206280, 0.206280
#*# 	-0.002144, -0.002144, -0.002144, -0.002144, -0.002144, 0.006547, 0.011297, 0.016181, 0.024279, 0.013305, -0.001349, 0.012208, 0.050285, 0.103604, 0.135128, 0.165901, 0.198318, 0.198318, 0.198318, 0.198318, 0.198318
#*# 	-0.004290, -0.004290, -0.004290, -0.004290, -0.004290, -0.004290, -0.004290, 0.001249, 0.011656, 0.001964, -0.001332, 0.025415, 0.070520, 0.118907, 0.175308, 0.175308, 0.175308, 0.175308, 0.175308, 0.175308, 0.175308
#*# 	-0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827, -0.001827
#*# tension = 0.2
#*# min_x = -130.0
#*# algo = bicubic
#*# y_count = 21
#*# mesh_y_pps = 2
#*# min_y = -130.0
#*# x_count = 21
#*# max_y = 130.0
#*# mesh_x_pps = 2
#*# max_x = 130.0
#*#
#*# [delta_calibrate]
#*# height0 = 17.459
#*# height0_pos = 205429.667,204984.000,205301.333
#*# height1 = 17.459
#*# height1_pos = 252048.667,252283.667,181236.667
#*# height2 = 17.459
#*# height2_pos = 200990.333,279019.333,201022.333
#*# height3 = 17.459
#*# height3_pos = 182210.333,243524.333,244217.333
#*# height4 = 17.459
#*# height4_pos = 199382.000,198580.000,254907.667
#*# height5 = 17.459
#*# height5_pos = 237506.333,182983.000,237209.667
#*# height6 = 17.459
#*# height6_pos = 266290.667,199818.667,199868.333
#*# distance0 = 96.6
#*# distance0_pos1 = 214302.307,217372.210,217710.717
#*# distance0_pos2 = 194142.660,249926.878,250570.206
#*# distance1 = 96.62
#*# distance1_pos1 = 215478.751,215011.090,218903.413
#*# distance1_pos2 = 211146.395,210340.248,275291.893
#*# distance2 = 96.58
#*# distance2_pos1 = 217840.259,213858.777,217710.717
#*# distance2_pos2 = 250834.813,193699.944,250570.206
#*# distance3 = 96.39
#*# distance3_pos1 = 219025.439,215044.474,215349.293
#*# distance3_pos2 = 275413.571,210843.309,210912.560
#*# distance4 = 96.55
#*# distance4_pos1 = 217825.242,217406.042,214180.250
#*# distance4_pos2 = 250549.525,250569.630,194020.403
#*# distance5 = 96.93
#*# distance5_pos1 = 215463.934,218581.781,215349.293
#*# distance5_pos2 = 210923.111,274968.498,210912.560
#*# distance6 = 97.09
#*# distance6_pos1 = 195266.399,242917.856,247766.385
#*# distance6_pos2 = 212704.046,208485.522,272417.291
#*# distance7 = 96.69
#*# distance7_pos1 = 212361.032,208172.685,266863.876
#*# distance7_pos2 = 251345.349,194086.517,246753.153
#*# distance8 = 96.77
#*# distance8_pos1 = 248010.112,194831.940,243526.158
#*# distance8_pos2 = 272528.086,212402.109,209039.151
#*# distance9 = 97.03
#*# distance9_pos1 = 266975.186,212049.664,208709.867
#*# distance9_pos2 = 246736.203,251069.128,194392.075
#*# distance10 = 96.51
#*# distance10_pos1 = 243521.001,247718.717,195137.509
#*# distance10_pos2 = 209057.993,272069.434,212469.263
#*# distance11 = 96.67
#*# distance11_pos1 = 208736.024,266517.285,212133.748
#*# distance11_pos2 = 194520.954,246118.280,251089.510
